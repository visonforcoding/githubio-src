---
title: MyBatis Dynamic SQL使用尝试
date: 2020-06-01 23:05:29
tags: java
---

首先说明下，我可能是被这个插件的名字给误导了。我原本以为Dynamic SQL是为了解决动态查询场景的。但可能`MyBatis Dynamic SQL` 并不是来解决这个问题的。

20.06.04更新

**打脸了**，原来它是支持的，果然是动态sql.并且还真香！

<!--more-->

## MyBatis Dynamic SQL

### 官方定义

This library is a framework for generating dynamic SQL statements. Think of it as a typesafe SQL templating library, with additional support for MyBatis3 and Spring JDBC Templates.

The primary goals of the library are:

- Typesafe - to the extent possible, the library will ensure that parameter types match the database column types
- Expressive - statements are built in a way that clearly communicates their meaning (thanks to Hamcrest for some inspiration)
- Flexible - where clauses can be built using any combination of and, or, and nested conditions
- Extensible - the library will render statements for MyBatis3, Spring JDBC templates or plain JDBC. It can be extended to generate clauses for other frameworks as well. Custom where conditions can be added easily if none of the built in conditions are sufficient for your needs.
- Small - the library is a small dependency to add. It has no transitive dependencies.

官方似乎说到这个类库的主要目标是解决类型安全问题。

This library grew out of a desire to create a utility that could be used to improve the code generated by MyBatis Generator, but the library can be used on it’s own with very little setup required.

官方说可以使用`MyBatis Generator`生成代码文件。

```xml
<dependency>
    <groupId>org.mybatis.dynamic-sql</groupId>
    <artifactId>mybatis-dynamic-sql</artifactId>
    <version>1.1.4</version>
</dependency>
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
</dependency>
```

## MyBatis Generator

MyBatis Generator may generate:

Java or Kotlin classes that match the table structure. This may include:
- a class to match the primary key of the table (if there is a primary key)
- a class to match the non-primary key fields of the table (except BLOB fields)
- a class to include the BLOB fields of a table (if the table has BLOB fields)
- a class to enable dynamic selects, updates, and deletes

`MyBatis Generator`将会生成下述三个文件：

- 与表对应的 model 类 Employee.java
- 定义了表信息和列信息的 support 类 EmployeeDynamicSqlSupport.java
- 以注解形式实现的 mapper 接口 EmployeeMapper.java

### Running MyBatis Generator With Maven

1. 配置pom.xml

```xml
           <plugin>
                <groupId>org.mybatis.generator</groupId>
                <artifactId>mybatis-generator-maven-plugin</artifactId>
                <version>1.4.0</version>
                <executions>
                    <execution>
                        <id>Generate MyBatis Artifacts</id>
                        <goals>
                            <goal>generate</goal>
                        </goals>
                    </execution>
                </executions>
                <dependencies>
                    <dependency>
                        <groupId>mysql</groupId>
                        <artifactId>mysql-connector-java</artifactId>
                        <version>8.0.20</version>
                    </dependency>
                </dependencies>
            </plugin>
```

注意`mysql-connector-java`依赖配置

2. 配置 generatorConfig.xml

在resource中配置生成配置文件generatorConfig.xml

```xml
<!DOCTYPE generatorConfiguration PUBLIC
 "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"
 "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd">
<generatorConfiguration>
  <context id="dsql" targetRuntime="MyBatis3DynamicSql">
    <jdbcConnection driverClass="com.mysql.jdbc.Driver"
        connectionURL="jdbc:mysql://localhost:3306/db_itdoc" userId="username" password="password" />

    <javaModelGenerator targetPackage="com.vison.itdoc.entity" targetProject="src/main/java"/>

    <javaClientGenerator targetPackage="com.vison.itdoc.dao" targetProject="src/main/java"/>

    <table tableName="task" />
  </context>
</generatorConfiguration>
```

`userId`和`password`分别是数据库用户名和密码

3. 执行生成

```shell
$ mvn mybatis-generator:generate
```

## 使用MyBatis Dynamic SQL

当相应的文件生成之后，这个时候可以直接使用了。

```java
   SelectStatementProvider queryCount = select(count())
                .from(task)
                .build()
                .render(RenderingStrategies.MYBATIS3);
        Long taskCount = taskMapper.count(queryCount);
        double total = Math.ceil(taskCount / iPageSize);
        SelectStatementProvider tasksQuerypProvider = select(createTime).from(task)
                .orderBy(createTime)
                .limit(iPageSize).offset(iOffset).build()
                .render(RenderingStrategy.MYBATIS3);
    List<Task> tasks = taskMapper.selectMany(tasksQuerypProvider);
```

`MyBatis Dynamic SQL`非常优雅得sqlbuilder方式,会提示表字段名。

### 动态sql

在这之前`mybatis`可以使用xml或注解方式进行动态组织sql

```java
public class TaskService {

    public String queryCount(String type, String remark) {
        return new SQL() {
            {
                SELECT("T.ID");
                FROM("TASK T");
                if (type != null) {
                    WHERE("T.type = #{type}");
                }
                if (remark != null) {
                    WHERE("T.remark = #{remark}");
                }
                ORDER_BY("T.create_time");
            }
        }.toString();
    }
```

在mapper上

```java
  @SelectProvider(type = TaskService.class, method = "queryCount")
    public Object queryCount(String type, String remark);
```

现在可以换另一种方式

```java

    public SelectStatementProvider countTask(Integer typeInteger, String remarkString) {
        QueryExpressionDSL<SelectModel>.QueryExpressionWhereBuilder builder = select(count())
                .from(task).where();
        if (typeInteger != null) {
            builder.and(type, isEqualTo(typeInteger));
        }
        if (remarkString != null) {
            builder.and(remark, isEqualTo(remarkString));
        }
        return builder.build().render(RenderingStrategy.MYBATIS3);
    }

    public SelectStatementProvider search(Object searchObj, Integer iPageSize, Integer iOffset) {
        QueryExpressionDSL<SelectModel>.QueryExpressionWhereBuilder builder = select(remark, type, createTime, modifyTime)
                .from(task).where();
        builder
                .orderBy(createTime)
                .limit(iPageSize).offset(iOffset);
        return builder.build().render(RenderingStrategy.MYBATIS3);
    }
```
从编码感受上，由于根据表结构生成了`SqlSupport`.任何对表的信息引用都能有提示，包括表名、字段名。

```java
List<Task> tasks = taskMapper.selectMany(taskService.search(null, iPageSize, iOffset));
```
调用上面，也无需在mapper上再编写方法，因为已经全部生成了。


## 参考

[Mybatis Dynamic SQL - 重新定义 Mybatis 动态 SQL](https://blog.olowolo.com/post/new-mybatis-dynamic-sql/)






